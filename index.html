<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Pulse Music — Ultimate Discovery</title>

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20 50 L40 80 L50 20 L60 80 L80 50' fill='none' stroke='%239333ea' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/></svg>"><link rel="icon" type="image/svg+xml" href="logo.PNG">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0b0c">
<link rel="apple-touch-icon" href="logo-512.PNG">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600&family=Outfit:wght@400;700&display=swap" rel="stylesheet">

<style>
/* CORE STYLES */
body { font-family: 'Outfit', sans-serif; background-color: #0b0b0c; color: white; margin: 0; overflow-x: hidden; }
.logo-font { font-family: "Space Grotesk", sans-serif; }

/* CURSOR GLOW - Dynamic Background */
#cursor-glow {
    position: fixed;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(147, 51, 234, 0.08) 0%, rgba(0,0,0,0) 70%);
    border-radius: 50%;
    pointer-events: none;
    transform: translate(-50%, -50%);
    z-index: 0;
    transition: background 1s ease; /* Smooth color change */
}

/* GLASSMORPHISM CARD */
.glass-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
}

.glass-card:hover {
    background: rgba(255, 255, 255, 0.07);
    border-color: var(--accent-color, rgba(147, 51, 234, 0.5));
    transform: translateY(-5px);
    box-shadow: 0 10px 40px -10px var(--accent-glow, rgba(147, 51, 234, 0.3));
}

/* GENRE PILLS */
.genre-pill {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
}
.genre-pill:hover, .genre-pill.active {
    background: var(--accent-main, #9333ea);
    border-color: var(--accent-main, #9333ea);
    transform: scale(1.05);
    box-shadow: 0 0 15px var(--accent-glow, rgba(147, 51, 234, 0.4));
}

/* SIDEBAR TRANSITION */
#sidebar {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* PROGRESS BAR */
#progressContainer {
    cursor: pointer;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    width: 100%;
    position: absolute;
    top: -6px;
    left: 0;
    transition: height 0.2s;
}
#progressContainer:hover { height: 10px; top: -10px; }
#progressBar {
    height: 100%;
    background: var(--accent-main, #9333ea);
    width: 0%;
    position: relative;
    border-radius: 0 4px 4px 0;
    transition: width 0.1s linear;
}
#progressBar::after {
    content: '';
    position: absolute;
    right: -6px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    background: white;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
    box-shadow: 0 0 10px rgba(255,255,255,0.5);
}
#progressContainer:hover #progressBar::after { opacity: 1; }

/* TOAST */
#toast {
    position: fixed;
    bottom: 120px;
    right: 20px;
    background: var(--accent-main, #9333ea);
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 14px;
    transform: translateY(200px);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 200;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #0b0b0c; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

/* MODAL */
#playlistModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    z-index: 250;
    align-items: center;
    justify-content: center;
}
</style>
</head>

<body>

<div id="cursor-glow"></div>
<div id="toast">Track Added</div>

<div id="playlistModal">
    <div class="bg-[#121214] p-8 rounded-3xl w-80 border border-white/10 shadow-2xl">
        <h3 class="text-lg font-bold mb-6 text-center text-purple-400 uppercase tracking-widest">Add to Playlist</h3>
        <div id="playlistOptions" class="flex flex-col gap-2 mb-6 max-h-56 overflow-y-auto"></div>
        <div class="flex flex-col gap-3">
            <button onclick="createNewPlaylistPrompt()" class="w-full py-3 bg-purple-600 rounded-xl text-xs font-bold uppercase hover:bg-purple-500 transition">+ New Playlist</button>
            <button onclick="closePlaylistModal()" class="w-full py-3 text-xs font-bold uppercase text-gray-500 hover:text-white transition">Cancel</button>
        </div>
    </div>
</div>

<div class="flex h-screen overflow-hidden relative z-10">

    <div class="md:hidden fixed top-0 left-0 w-full p-4 flex justify-between items-center bg-[#0b0b0c]/80 backdrop-blur-md z-50 border-b border-white/5">
        <button id="burgerBtn" class="p-2 text-white bg-white/5 rounded-lg border border-white/10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <div class="logo-font text-xl font-bold text-purple-500">PULSE</div>
        <div class="w-8"></div> </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-[60] w-72 bg-[#0e0e0f] border-r border-white/5 transform -translate-x-full md:translate-x-0 md:static flex flex-col p-8">
        <div class="logo-font text-3xl font-bold text-purple-600 mb-10 tracking-tighter hidden md:block">PULSE</div>
        
        <nav class="flex-1 flex flex-col gap-6 overflow-y-auto">
            <div class="flex flex-col gap-2">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-500 mb-2">Discover</p>
                <a href="index.html" onclick="loadTrending()" class="flex items-center gap-3 text-sm font-bold text-white hover:text-purple-400 transition p-2 hover:bg-white/5 rounded-lg">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Top Charts
                </a>                <a href="artists.html" onclick="loadTrending()" class="flex items-center gap-3 text-sm font-bold text-white hover:text-purple-400 transition p-2 hover:bg-white/5 rounded-lg">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Artists
                </a>                <a href="playlist.html" onclick="loadTrending()" class="flex items-center gap-3 text-sm font-bold text-white hover:text-purple-400 transition p-2 hover:bg-white/5 rounded-lg">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Playlists
                </a>
            </div>

            <div class="border-t border-white/5 my-2"></div>

            <div class="flex flex-col gap-2">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-500 mb-2">Library</p>
                <div id="sidebarPlaylists" class="flex flex-col gap-1"></div>
            </div>
        </nav>
        
        <div class="mt-auto pt-6 border-t border-white/5">
            <p class="text-[10px] text-gray-600 text-center uppercase tracking-widest">Pulse AI v3.0</p>
        </div>
    </aside>

    <div id="mobileOverlay" class="fixed inset-0 bg-black/80 z-[55] hidden backdrop-blur-sm transition-opacity"></div>

    <main class="flex-1 overflow-y-auto p-6 md:p-10 pb-40 mt-16 md:mt-0 scroll-smooth">
        
        <div class="relative max-w-2xl mx-auto mb-12">
            <input id="searchInput" type="text" placeholder="Search artists, tracks, vibes..." class="w-full bg-[#18181b] border border-white/10 rounded-full py-4 pl-12 pr-6 text-sm focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all placeholder-gray-600">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>

        <div class="mb-10">
            <h2 class="text-xs font-bold uppercase tracking-[0.3em] text-gray-400 mb-6">Select Mood</h2>
            <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                <button onclick="aiMood('melancholic', '#3b82f6')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest border-blue-500/30">Melancholic</button>
                <button onclick="aiMood('aggressive', '#ef4444')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest border-red-500/30">Aggressive</button>
                <button onclick="aiMood('euphoric', '#10b981')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest border-green-500/30">Euphoric</button>
                <button onclick="aiMood('dark', '#6b21a8')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest border-purple-800/30">Dark / Void</button>
                <button onclick="aiMood('chill', '#f59e0b')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest border-yellow-500/30">Chill</button>
            </div>
        </div>

        <div class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xs font-bold uppercase tracking-[0.3em] text-gray-400">Select Genre</h2>
            </div>
            <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                <button onclick="aiRecommend('post-punk')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Post-Punk</button>
                <button onclick="aiRecommend('punk')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Punk</button>
                <button onclick="aiRecommend('rock')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Rock</button>
                <button onclick="aiRecommend('grunge')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Grunge</button>
                <button onclick="aiRecommend('metal')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Metal</button>
                <button onclick="aiRecommend('phonk')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Phonk</button>
                <button onclick="aiRecommend('industrial')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Industrial</button>
                <button onclick="aiRecommend('midwest-emo')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Midwest Emo</button>
                <button onclick="aiRecommend('shoegaze')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Shoegaze</button>
                <button onclick="aiRecommend('jazz')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Jazz</button>
                <button onclick="aiRecommend('trip-hop')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Trip-Hop</button>
                <button onclick="aiRecommend('breakcore')" class="genre-pill px-5 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest">Breakcore</button>
            </div>
        </div>

        <div id="aiLoader" class="hidden py-12 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-500 mb-2"></div>
            <p class="text-purple-500 text-xs font-bold uppercase tracking-widest animate-pulse">Digging through archives...</p>
        </div>

        <h2 id="sectionTitle" class="text-2xl md:text-4xl font-bold mb-8 italic tracking-tighter text-white/90">Trending Now</h2>
        <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>

    </main>
</div>

<footer class="fixed bottom-0 left-0 right-0 bg-[#0b0b0c]/95 backdrop-blur-xl border-t border-white/10 z-[70]">
    <div id="progressContainer">
        <div id="progressBar"></div>
    </div>

    <div class="flex items-center justify-between p-4 md:px-8 md:py-4 h-20 md:h-24">
        
        <div class="flex items-center gap-4 w-1/3 min-w-0">
            <div class="relative w-12 h-12 md:w-16 md:h-16 shrink-0 rounded-lg overflow-hidden border border-white/10 group">
                <img id="cover" class="w-full h-full object-cover bg-[#1a1a1a]">
                <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="openPlaylistModalFromPlayer()" class="text-white hover:scale-110 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button>
                </div>
            </div>
            <div class="min-w-0 flex flex-col justify-center">
                <p id="trackTitle" class="text-sm font-bold text-white truncate">Select a Track</p>
                <p id="trackArtist" class="text-[10px] font-bold text-purple-500 uppercase tracking-wider truncate mt-0.5">PULSE AI</p>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center w-1/3">
            <div class="flex items-center gap-6">
                <button onclick="prevTrack()" class="text-gray-400 hover:text-white transition"><svg class="w-5 h-5 md:w-6 md:h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11 19L2 12l9-7v14zM22 5v14h-2V5z"/></svg></button>
                <button id="playBtn" class="bg-white text-black p-3 md:p-4 rounded-full hover:scale-105 transition shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                    <svg id="playIcon" class="w-5 h-5 md:w-6 md:h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button onclick="nextTrack()" class="text-gray-400 hover:text-white transition"><svg class="w-5 h-5 md:w-6 md:h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M13 5l9 7-9 7V5zM2 5h2v14H2z"/></svg></button>
            </div>
        </div>

        <div class="hidden md:flex items-center justify-end gap-4 w-1/3">
            <svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
            <input type="range" id="volumeSlider" class="w-24 h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-600" min="0" max="1" step="0.01" value="1">
            <button onclick="openPlaylistModalFromPlayer()" class="p-2 text-gray-400 hover:text-white border border-white/10 rounded-full hover:bg-white/5 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>
    </div>
    <audio id="audioPlayer"></audio>
</footer>

<script>
// --- CONFIG & DATA ---
const AI_DATA = {
    "post-punk": ["Joy Division", "The Cure", "Bauhaus", "The Sound", "The Chameleons", "Interpol", "She Past Away", "Lebanon Hanover", "ДК Енергетик", "Mistmorn", "Burnout", "SadSvit", "Siouxsie and the Banshees", "The Soft Moon", "Drab Majesty", "Echo & the Bunnymen", "Sudno (Ukr Cover)"],
    "punk": ["The Clash", "Ramones", "Sex Pistols", "Dead Kennedys", "Iggy Pop", "The Stooges", "Black Flag", "Misfits", "Beton", "Zhadan i Sobaky"],
    "rock": ["The White Stripes", "Royal Blood", "Soundgarden", "Alice in Chains", "Strayed", "Schmalgauzen", "Epolets", "The Black Keys", "Queens of the Stone Age", "Ziferblat", "Jack White", "The Dead Weather", "Arctic Monkeys"],
    "metal": ["Metallica", "Iron Maiden", "Gojira", "Jinjer", "1914", "Whitechapel", "Mastodon", "Opeth", "System of a Down", "Sepultura", "Motanka", "Ignea"],
    "grunge": ["Nirvana", "Soundgarden", "Alice in Chains", "Pearl Jam", "Mudhoney", "Melvins", "Stone Temple Pilots", "L7", "Hole", "Temple of the Dog"],
    "shoegaze": ["My Bloody Valentine", "Slowdive", "Ride", "Lush", "Cocteau Twins", "Whirr", "Nothing", "Diiv", "Yah", "Pygmalion", "Hazy", "Hum"],
    "phonk": ["Kordhell", "DVRST", "Pharmacist", "Interworld", "Hensonn", "MoonDeity", "Pradaaslife", "Ghostface Playa", "MUPP", "LXST CXNTURY"],
    "industrial": ["Nine Inch Nails", "Ministry", "Einstürzende Neubauten", "Skinny Puppy", "Front 242", "Kurs Valüt", "Gehenna", "Deathstars", "Laibach", "Rammstein"],
    "midwest-emo": ["American Football", "Sunny Day Real Estate", "The Get Up Kids", "Mineral", "Cap'n Jazz", "Modern Baseball", "Marietta", "Keepy-Uppy", "Standarder"],
    "jazz": ["Miles Davis", "John Coltrane", "The Dave Brubeck Quartet", "Kamasi Washington", "BadBadNotGood", "GoGo Penguin", "Yussef Dayes", "Pokaz Trio"],
    "trip-hop": ["Portishead", "Massive Attack", "Tricky", "Morcheeba", "Sneaker Pimps", "Archive", "Nightmares on Wax"],
    "breakcore": ["Venetian Snares", "Igorrr", "Sewerslvt", "Ruby My Dear", "Machine Girl", "Aphex Twin", "Squarepusher"]
};

const MOOD_DATA = {
    "melancholic": ["Slowdive", "The Smiths", "Mistmorn", "Radiohead", "Beach House", "Cocteau Twins"],
    "aggressive": ["Death Grips", "Jinjer", "The Stooges", "1914", "Idles", "Beton"],
    "euphoric": ["M83", "Tame Impala", "The Naked and Famous", "Empire of the Sun", "MGMT"],
    "dark": ["Bauhaus", "Perturbator", "Burzum", "Lorn", "She Past Away", "Lebanon Hanover"],
    "chill": ["Bonobo", "Air", "Zero 7", "Nightmares on Wax", "Thievery Corporation"]
};

// --- DOM ELEMENTS ---
const elements = {
    grid: document.getElementById("grid"),
    audio: document.getElementById("audioPlayer"),
    title: document.getElementById("trackTitle"),
    artist: document.getElementById("trackArtist"),
    cover: document.getElementById("cover"),
    loader: document.getElementById("aiLoader"),
    sectionTitle: document.getElementById("sectionTitle"),
    progressBar: document.getElementById("progressBar"),
    progressContainer: document.getElementById("progressContainer"),
    playBtn: document.getElementById("playBtn"),
    playIcon: document.getElementById("playIcon"),
    volumeSlider: document.getElementById("volumeSlider"),
    searchInput: document.getElementById("searchInput"),
    burgerBtn: document.getElementById("burgerBtn"),
    sidebar: document.getElementById("sidebar"),
    overlay: document.getElementById("mobileOverlay"),
    cursorGlow: document.getElementById("cursor-glow"),
    toast: document.getElementById("toast"),
    playlistModal: document.getElementById("playlistModal"),
    playlistOptions: document.getElementById("playlistOptions")
};

let state = {
    tracks: [],
    currentIndex: 0,
    trackToSave: null,
    isPlaying: false
};

// --- INITIALIZATION ---
function init() {
    setupEventListeners();
    updateSidebarPlaylists();
    loadTrending();
}

// --- EVENT LISTENERS ---
function setupEventListeners() {
    document.addEventListener('mousemove', (e) => {
        elements.cursorGlow.style.left = e.clientX + 'px';
        elements.cursorGlow.style.top = e.clientY + 'px';
    });
    elements.burgerBtn.onclick = toggleSidebar;
    elements.overlay.onclick = toggleSidebar;
    elements.playBtn.onclick = togglePlay;
    elements.audio.onended = nextTrack;
    elements.audio.ontimeupdate = updateProgress;
    elements.progressContainer.onclick = seek;
    elements.volumeSlider.oninput = (e) => elements.audio.volume = e.target.value;
    let timeout;
    elements.searchInput.addEventListener("input", (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const v = e.target.value;
            if (v.length > 2) search(v);
        }, 500);
    });
}

// --- CORE FUNCTIONS ---
function toggleSidebar() {
    const isClosed = elements.sidebar.classList.contains("-translate-x-full");
    if (isClosed) {
        elements.sidebar.classList.remove("-translate-x-full");
        elements.overlay.classList.remove("hidden");
    } else {
        elements.sidebar.classList.add("-translate-x-full");
        elements.overlay.classList.add("hidden");
    }
}

function showToast(msg) {
    elements.toast.textContent = msg;
    elements.toast.style.transform = "translateY(0)";
    setTimeout(() => elements.toast.style.transform = "translateY(200px)", 2500);
}

function updateThemeColor(color) {
    document.documentElement.style.setProperty('--accent-main', color);
    document.documentElement.style.setProperty('--accent-color', color + '80');
    document.documentElement.style.setProperty('--accent-glow', color + '4d');
    elements.cursorGlow.style.background = `radial-gradient(circle, ${color}20 0%, rgba(0,0,0,0) 70%)`;
}

// --- DATA FETCHING ---
async function fetchDeezer(url) {
    try {
        const proxy = "https://corsproxy.io/?";
        const res = await fetch(proxy + encodeURIComponent(url));
        const data = await res.json();
        return data.data || [];
    } catch (error) {
        console.error("API Error", error);
        return [];
    }
}

async function loadTrending() {
    updateThemeColor('#9333ea');
    elements.loader.classList.remove('hidden');
    state.tracks = await fetchDeezer("https://api.deezer.com/chart/0/tracks?limit=30");
    elements.sectionTitle.textContent = "Global Trending";
    elements.loader.classList.add('hidden');
    renderGrid();
    if(window.innerWidth < 768) toggleSidebar();
}

async function search(query) {
    elements.loader.classList.remove('hidden');
    elements.sectionTitle.textContent = `Results: ${query}`;
    state.tracks = await fetchDeezer(`https://api.deezer.com/search?q=${query}&limit=25`);
    elements.loader.classList.add('hidden');
    renderGrid();
}

async function aiMood(mood, color) {
    updateThemeColor(color);
    elements.loader.classList.remove('hidden');
    elements.sectionTitle.textContent = mood.toUpperCase() + " SELECTION";
    const artists = MOOD_DATA[mood];
    let collected = [];
    const shuffled = artists.sort(() => 0.5 - Math.random()).slice(0, 5);
    for (const name of shuffled) {
        const tracks = await fetchDeezer(`https://api.deezer.com/search?q=artist:"${name}"&limit=5`);
        collected = [...collected, ...tracks];
    }
    state.tracks = collected.sort(() => 0.5 - Math.random());
    elements.loader.classList.add('hidden');
    renderGrid();
}

async function aiRecommend(genre) {
    updateThemeColor('#9333ea');
    elements.loader.classList.remove('hidden');
    elements.sectionTitle.textContent = genre.toUpperCase();
    const artists = AI_DATA[genre] || [genre];
    let collected = [];
    const shuffledArtists = artists.sort(() => 0.5 - Math.random()).slice(0, 5);
    for (const name of shuffledArtists) {
        const tracks = await fetchDeezer(`https://api.deezer.com/search?q=artist:"${name}"&limit=5`);
        collected = [...collected, ...tracks];
    }
    state.tracks = collected.sort(() => 0.5 - Math.random());
    elements.loader.classList.add('hidden');
    renderGrid();
    if(window.innerWidth < 768 && !elements.sidebar.classList.contains("-translate-x-full")) toggleSidebar();
}

// --- RENDERING ---
function renderGrid() {
    elements.grid.innerHTML = "";
    state.tracks.forEach((t, i) => {
        if (!t.album || !t.artist) return;
        const card = document.createElement("div");
        card.className = "glass-card p-4 rounded-3xl cursor-pointer group relative";
        card.innerHTML = `
            <div class="relative overflow-hidden rounded-2xl aspect-square mb-4">
                <img src="${t.album.cover_medium}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                    <button class="play-btn bg-[var(--accent-main)] p-3 rounded-full hover:scale-110 transition shadow-lg text-white">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button class="add-btn bg-white/20 backdrop-blur-md p-3 rounded-full hover:bg-white/40 transition text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                    </button>
                </div>
            </div>
            <h3 class="font-bold text-white text-sm truncate pr-2">${t.title}</h3>
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1 truncate">${t.artist.name}</p>
        `;
        card.querySelector('.play-btn').onclick = (e) => { e.stopPropagation(); playTrack(i); };
        card.querySelector('.add-btn').onclick = (e) => { e.stopPropagation(); openPlaylistModal(i); };
        card.onclick = () => playTrack(i);
        elements.grid.appendChild(card);
    });
}

// --- AUDIO PLAYER ---
function playTrack(index) {
    state.currentIndex = index;
    const track = state.tracks[index];
    if (!track) return;
    elements.audio.src = track.preview;
    elements.title.textContent = track.title;
    elements.artist.textContent = track.artist.name;
    elements.cover.src = track.album.cover_small;
    elements.audio.play();
    state.isPlaying = true;
    updatePlayIcon();
}

function togglePlay() {
    if (elements.audio.paused) {
        elements.audio.play();
        state.isPlaying = true;
    } else {
        elements.audio.pause();
        state.isPlaying = false;
    }
    updatePlayIcon();
}

function updatePlayIcon() {
    elements.playIcon.innerHTML = state.isPlaying ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
}

function nextTrack() { playTrack((state.currentIndex + 1) % state.tracks.length); }
function prevTrack() { playTrack((state.currentIndex - 1 + state.tracks.length) % state.tracks.length); }
function updateProgress() {
    const { duration, currentTime } = elements.audio;
    if (duration) elements.progressBar.style.width = `${(currentTime / duration) * 100}%`;
}
function seek(e) {
    const rect = elements.progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    if (elements.audio.duration) elements.audio.currentTime = percent * elements.audio.duration;
}

// --- PLAYLIST SYSTEM ---
function getPlaylists() {
    const data = localStorage.getItem('pulse_v3_playlists');
    return data ? JSON.parse(data) : [{ id: 1, name: "Favorites", tracks: [] }];
}

function savePlaylists(pl) {
    localStorage.setItem('pulse_v3_playlists', JSON.stringify(pl));
    updateSidebarPlaylists();
}

function updateSidebarPlaylists() {
    const container = document.getElementById('sidebarPlaylists');
    const playlists = getPlaylists();
    container.innerHTML = "";
    playlists.forEach(pl => {
        const btn = document.createElement('button');
        btn.className = "text-left w-full flex items-center gap-3 text-xs font-bold text-gray-400 hover:text-white transition p-2 hover:bg-white/5 rounded-lg group";
        btn.innerHTML = `<div class="w-6 h-6 bg-purple-500/10 rounded flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition">${pl.name.charAt(0).toUpperCase()}</div>${pl.name}`;
        btn.onclick = () => { state.tracks = pl.tracks; elements.sectionTitle.textContent = pl.name; renderGrid(); if(window.innerWidth < 768) toggleSidebar(); };
        container.appendChild(btn);
    });
}

function openPlaylistModal(index) {
    state.trackToSave = state.tracks[index];
    renderPlaylistOptions();
    elements.playlistModal.style.display = "flex";
}

function openPlaylistModalFromPlayer() {
    if (state.tracks[state.currentIndex]) {
        state.trackToSave = state.tracks[state.currentIndex];
        renderPlaylistOptions();
        elements.playlistModal.style.display = "flex";
    }
}

function closePlaylistModal() { elements.playlistModal.style.display = "none"; }

function renderPlaylistOptions() {
    elements.playlistOptions.innerHTML = "";
    const playlists = getPlaylists();
    playlists.forEach(pl => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left p-3 bg-white/5 rounded-xl text-xs font-bold flex justify-between items-center hover:bg-white/10 transition border border-white/5 mb-2";
        btn.innerHTML = `<span>${pl.name}</span><span class="text-gray-500">${pl.tracks.length}</span>`;
        btn.onclick = () => {
            if (!pl.tracks.find(t => t.id === state.trackToSave.id)) {
                pl.tracks.push(state.trackToSave);
                savePlaylists(playlists);
                showToast(`Added to ${pl.name}`);
            } else { showToast("Already in playlist"); }
            closePlaylistModal();
        };
        elements.playlistOptions.appendChild(btn);
    });
}

function createNewPlaylistPrompt() {
    const name = prompt("Enter Playlist Name:");
    if (name) {
        const playlists = getPlaylists();
        playlists.push({ id: Date.now(), name, tracks: [] });
        savePlaylists(playlists);
        renderPlaylistOptions();
    }
}

init();
</script>
</body>
</html>
